<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2a2a2f">
    
    <!-- App Icons - Using relative paths -->
    <link rel="icon" type="image/png" href="./favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="TeamProject" />
    <link rel="manifest" href="./site.webmanifest" />
    
    <title>Team Project Manager</title>
    
    <style>
        :root {
            /* Charcoal color scheme */
            --primary-gradient: linear-gradient(135deg, #2a2a2f 0%, #45454d 100%);
            --primary-color: #2a2a2f;
            --primary-dark: #1a1a1f;
            --primary-light: #5a5a62;
            --bg-color: #f5f5f7;
            --card-bg: #ffffff;
            --text-primary: #3a3a3a;
            --text-secondary: #5a5a5a;
            --border-color: #d9d9dc;
            --shadow-color: rgba(42, 42, 47, 0.15);
            --success: #7fa67f;
            --warning: #f39c12;
            --danger: #d99ea7;
            --contrast: 1;
            --brightness: 1;
            --font-scale: 1;
        }
        
        /* IMPROVED CONTRAST LEVELS - 30% difference each */
        body.low-contrast { 
            --contrast: 0.7; 
            --brightness: 1.15; 
        }
        body { 
            filter: contrast(var(--contrast)) brightness(var(--brightness)); 
        }
        body.high-contrast { 
            --contrast: 1.3; 
            --brightness: 0.95; 
            --text-primary: #1a1a1a; 
            --text-secondary: #3a3a3a; 
            --border-color: #999; 
        }
        body.extra-high-contrast { 
            --contrast: 1.6; 
            --brightness: 0.9; 
            --text-primary: #000; 
            --text-secondary: #2a2a2a; 
            --border-color: #666;
            --card-bg: #fafafa;
        }
        /* Ensure buttons stay visible in high contrast */
        body.high-contrast .btn, body.extra-high-contrast .btn { border: 2px solid currentColor; font-weight: 600; }
        body.high-contrast .header-btn, body.extra-high-contrast .header-btn { border: 2px solid white; }

        body.font-small { --font-scale: 0.85; }
        body.font-large { --font-scale: 1.15; }
        body.font-xlarge { --font-scale: 1.3; }

        .night-mode { 
            --bg-color: #1a1a20; 
            --card-bg: #2d2d35; 
            --text-primary: #f0f0f0; 
            --text-secondary: #c0c0c8; 
            --border-color: #4a4a52; 
            --shadow-color: rgba(0,0,0,0.5);
            --primary-gradient: linear-gradient(135deg, #3a3a42 0%, #55555d 100%);
            --primary-color: #3a3a42;
            --primary-light: #5a5a62;
        }
        .night-mode .stat-card, .night-mode .project-card, .night-mode .kanban-column, .night-mode .list-view, .night-mode .schedule-view { background: var(--card-bg); }
        .night-mode .task-item, .night-mode .kanban-task { background: #3a3a42; border-color: #505058; color: var(--text-primary); }
        .night-mode .modal-content, .night-mode .settings-panel { background: var(--card-bg); color: var(--text-primary); }
        .night-mode input, .night-mode select, .night-mode textarea { background: #25252b; color: var(--text-primary); border-color: var(--border-color); }
        .night-mode .activity-item { background: #3a3a42; border-color: #505058; }
        .night-mode .gantt-labels-panel, .night-mode .gantt-label-header, .night-mode .gantt-date-cell { background: var(--card-bg); color: var(--text-primary); }
        .night-mode .gantt-date-cell.weekend { background: #35353d; }
        .night-mode .gantt-timeline-row { border-bottom-color: var(--border-color); }
        
        /* 18 ENHANCED Themes with Background Colors */
        .theme-navy { --primary-gradient: linear-gradient(135deg, #6b7c93 0%, #8fa3bf 100%); --primary-color: #6b7c93; --bg-color: #e8ecf0; --primary-light: #b5c3d6; --border-color: #c5cdd6; }
        .theme-steel { --primary-gradient: linear-gradient(135deg, #7899b3 0%, #a8c5d6 100%); --primary-color: #7899b3; --bg-color: #e6eff5; --primary-light: #b8d5e6; --border-color: #c9d5e2; }
        .theme-slate { --primary-gradient: linear-gradient(135deg, #708090 0%, #94a3b2 100%); --primary-color: #708090; --bg-color: #e9edef; --primary-light: #b4c2cf; --border-color: #cbd2d9; }
        .theme-sage { --primary-gradient: linear-gradient(135deg, #87a087 0%, #a8c0a8 100%); --primary-color: #87a087; --bg-color: #eef4ee; --primary-light: #c4d8c4; --border-color: #cddccd; }
        .theme-olive { --primary-gradient: linear-gradient(135deg, #8b8c7a 0%, #abac9a 100%); --primary-color: #8b8c7a; --bg-color: #f1f1eb; --primary-light: #cbcbb7; --border-color: #d5d5cc; }
        .theme-forest { --primary-gradient: linear-gradient(135deg, #6f8f6f 0%, #8faf8f 100%); --primary-color: #6f8f6f; --bg-color: #ecf2ec; --primary-light: #b7d3b7; --border-color: #c5d8c5; }
        .theme-plum { --primary-gradient: linear-gradient(135deg, #8b7a8f 0%, #ab9aaf 100%); --primary-color: #8b7a8f; --bg-color: #f1ecf3; --primary-light: #cbbed3; --border-color: #d5ccd8; }
        .theme-mauve { --primary-gradient: linear-gradient(135deg, #9b8b9f 0%, #bbabcf 100%); --primary-color: #9b8b9f; --bg-color: #f3eef6; --primary-light: #d5c5df; --border-color: #d8d0dc; }
        .theme-wisteria { --primary-gradient: linear-gradient(135deg, #8b88a8 0%, #aba8c8 100%); --primary-color: #8b88a8; --bg-color: #f1f0f8; --primary-light: #cbc8e2; --border-color: #d5d3e2; }
        .theme-taupe { --primary-gradient: linear-gradient(135deg, #8b8680 0%, #aba6a0 100%); --primary-color: #8b8680; --bg-color: #f1eeec; --primary-light: #cbc6c0; --border-color: #d5d1cc; }
        .theme-mushroom { --primary-gradient: linear-gradient(135deg, #9b9088 0%, #bbb0a8 100%); --primary-color: #9b9088; --bg-color: #f3f0ed; --primary-light: #d5ccc4; --border-color: #dad4ce; }
        .theme-cocoa { --primary-gradient: linear-gradient(135deg, #8b7b73 0%, #ab9b93 100%); --primary-color: #8b7b73; --bg-color: #f1edeb; --primary-light: #cbbdb5; --border-color: #d5ccc7; }
        .theme-dusty-rose { --primary-gradient: linear-gradient(135deg, #ba9a9f 0%, #dabac0 100%); --primary-color: #ba9a9f; --bg-color: #faf4f5; --primary-light: #ead4d8; --border-color: #edd8db; }
        .theme-coral { --primary-gradient: linear-gradient(135deg, #c99a93 0%, #e9bab3 100%); --primary-color: #c99a93; --bg-color: #fcf4f2; --primary-light: #f2d4cd; --border-color: #f2d8d3; }
        .theme-stone { --primary-gradient: linear-gradient(135deg, #9b9893 0%, #bbb8b3 100%); --primary-color: #9b9893; --bg-color: #f5f4f2; --primary-light: #d8d5d0; --border-color: #dddad5; }
        .theme-ash { --primary-gradient: linear-gradient(135deg, #888888 0%, #a8a8a8 100%); --primary-color: #888888; --bg-color: #f1f1f1; --primary-light: #c8c8c8; --border-color: #d5d5d5; }
        .theme-charcoal { --primary-gradient: linear-gradient(135deg, #2a2a2f 0%, #45454d 100%); --primary-color: #2a2a2f; --bg-color: #f5f5f7; --primary-light: #5a5a62; --border-color: #d9d9dc; }
        .theme-denim { --primary-gradient: linear-gradient(135deg, #6b87a8 0%, #8fabc8 100%); --primary-color: #6b87a8; --bg-color: #eff3f7; --primary-light: #b5c9df; --border-color: #c8d3df; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none; }
        
        html {
            overflow-x: hidden;
            width: 100%;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-color); 
            min-height: 100vh; 
            overflow-x: hidden; 
            transition: background 0.3s; 
            font-size: calc(14px * var(--font-scale));
            width: 100%;
            max-width: 100vw;
            position: relative;
        }
        
        .app-container { 
            width: 100%;
            max-width: 100vw;
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            margin: 0 auto;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Mobile-specific styles (iPhone 15 Pro Max and similar) */
        @media (max-width: 768px) {
            body {
                max-width: 100vw;
            }
            .app-container {
                max-width: 100vw;
            }
        }
        
        .header { 
            background: var(--primary-gradient); 
            color: white; 
            padding: 12px 16px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            position: sticky; 
            top: 0; 
            z-index: 100;
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
            /* iPhone notch safe area - INCREASED padding */
            padding-top: max(20px, env(safe-area-inset-top, 20px));
            padding-bottom: 12px;
        }
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 8px; 
            max-width: 1400px; 
            margin: 0 auto; 
            width: 100%;
        }
        .header-left { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }
        .header h1 { font-size: calc(16px * var(--font-scale)); font-weight: 600; white-space: nowrap; }
        .header-controls { display: flex; gap: 6px; align-items: center; flex-shrink: 0; }
        .header-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: calc(14px * var(--font-scale)); display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .header-btn:active { transform: scale(0.9); }
        
        .view-toggle { display: flex; gap: 2px; background: rgba(255,255,255,0.2); padding: 3px; border-radius: 6px; flex-shrink: 0; }
        .view-btn { padding: 5px 6px; border: none; background: transparent; color: white; cursor: pointer; border-radius: 4px; font-size: calc(9px * var(--font-scale)); transition: all 0.3s; white-space: nowrap; }
        .view-btn.active { background: rgba(255,255,255,0.3); }
        
        .sync-status-bar { position: fixed; top: calc(70px + env(safe-area-inset-top, 20px)); left: 0; right: 0; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 6px 16px; display: flex; align-items: center; justify-content: space-between; z-index: 90; font-size: calc(10px * var(--font-scale)); color: var(--text-secondary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); transform: translateY(-100%); transition: transform 0.3s ease-in-out; width: 100%; max-width: 100vw; opacity: 0.95; }
        .sync-status-bar.show { transform: translateY(0); }
        .sync-status-left { display: flex; align-items: center; gap: 8px; }
        .sync-icon { font-size: 16px; }
        .sync-icon.syncing { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .sync-badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 500; }
        .sync-badge.online { background: #d4edda; color: #155724; }
        .sync-badge.offline { background: #f8d7da; color: #721c24; }
        
        .settings-panel { position: fixed; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100%; background: var(--card-bg); box-shadow: -2px 0 10px rgba(0,0,0,0.2); transition: right 0.3s; z-index: 3000; overflow-y: auto; padding: calc(20px + env(safe-area-inset-top)) 20px calc(20px + env(safe-area-inset-bottom)); }
        .settings-panel.show { right: 0; }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .settings-title { font-size: calc(20px * var(--font-scale)); font-weight: 600; color: var(--text-primary); }
        .close-settings { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-secondary); }
        .settings-section { margin-bottom: 25px; }
        .settings-label { font-size: calc(13px * var(--font-scale)); font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; display: block; }
        
        .user-profile-section { background: var(--primary-gradient); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .user-profile-name { font-size: calc(16px * var(--font-scale)); font-weight: 600; margin-bottom: 5px; }
        .user-profile-role { font-size: calc(11px * var(--font-scale)); opacity: 0.9; }
        .change-name-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: calc(11px * var(--font-scale)); cursor: pointer; margin-top: 8px; }
        
        .auto-sync-options { display: flex; flex-direction: column; gap: 12px; margin-bottom: 15px; }
        .sync-interval-select { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-color); color: var(--text-primary); font-size: calc(13px * var(--font-scale)); }
        
        .contrast-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .contrast-btn { padding: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-primary); border-radius: 6px; font-size: calc(12px * var(--font-scale)); cursor: pointer; }
        .contrast-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        .font-size-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .font-btn { padding: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-primary); border-radius: 6px; font-size: 12px; cursor: pointer; }
        .font-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        .toggle-switch { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .toggle-switch input[type="checkbox"] { width: 44px; height: 24px; -webkit-appearance: none; appearance: none; background: #cbd5e0; border-radius: 12px; position: relative; cursor: pointer; }
        .toggle-switch input[type="checkbox"]:checked { background: var(--primary-color); }
        .toggle-switch input[type="checkbox"]::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: left 0.3s; }
        .toggle-switch input[type="checkbox"]:checked::after { left: 22px; }
        
        .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .theme-option-btn { padding: 10px; border: 1px solid var(--border-color); background: var(--bg-color); border-radius: 6px; cursor: pointer; font-size: calc(12px * var(--font-scale)); color: var(--text-primary); }
        .theme-option-btn:active { transform: scale(0.95); }
        .color-dot { width: 16px; height: 16px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 12px 16px; background: var(--bg-color); margin: 0 auto; width: 100%; max-width: 100vw; }
        .stat-card { background: var(--card-bg); padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px var(--shadow-color); text-align: center; }
        .stat-card h3 { font-size: calc(20px * var(--font-scale)); color: var(--primary-color); margin-bottom: 2px; }
        .stat-card p { font-size: calc(11px * var(--font-scale)); color: var(--text-secondary); }
        
        .container { flex: 1; padding: 12px 16px; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: calc(100px + env(safe-area-inset-bottom)); width: 100%; max-width: 100vw; }
        .dashboard-view { display: flex; flex-direction: column; gap: 15px; }
        .project-card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 2px 10px var(--shadow-color); overflow: hidden; max-width: 100%; }
        .project-header { background: var(--primary-gradient); color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .project-header h3 { font-size: calc(15px * var(--font-scale)); margin-bottom: 3px; }
        .project-actions { display: flex; gap: 5px; flex-shrink: 0; }
        .action-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: calc(11px * var(--font-scale)); }
        .project-body { padding: 12px; max-height: 300px; overflow-y: auto; }
        
        .task-item { padding: 12px; margin-bottom: 8px; background: var(--bg-color); border-radius: 8px; border-left: 3px solid var(--primary-color); position: relative; }
        .task-item.completed { opacity: 0.7; border-left-color: #7fa67f; }
        .task-item.overdue { border-left-color: #d99ea7; }
        .task-item.due-today { border-left-color: #f39c12; }
        .task-meta { font-size: calc(10px * var(--font-scale)); color: var(--text-secondary); margin-top: 5px; }
        .task-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; }
        .task-btn { background: var(--primary-color); color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: calc(10px * var(--font-scale)); cursor: pointer; }
        
        .status-indicator { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: calc(10px * var(--font-scale)); font-weight: 600; margin-left: 5px; }
        .status-indicator.in-progress { background: #fff3cd; color: #856404; }
        .status-indicator.due { background: #f8d7da; color: #721c24; }
        
        .kanban-view { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .kanban-column { min-width: 280px; background: var(--card-bg); border-radius: 10px; padding: 12px; box-shadow: 0 2px 10px var(--shadow-color); }
        .kanban-header { font-weight: 600; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid var(--border-color); font-size: calc(14px * var(--font-scale)); color: var(--text-primary); }
        .kanban-task { background: var(--bg-color); padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: move; font-size: calc(13px * var(--font-scale)); border: 2px solid transparent; }
        .kanban-task.dragging { opacity: 0.5; }
        
        .list-view { background: var(--card-bg); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px var(--shadow-color); }
        .list-header { display: grid; grid-template-columns: 2fr 1fr 1fr; padding: 12px; background: var(--bg-color); font-weight: 600; font-size: calc(12px * var(--font-scale)); color: var(--text-secondary); border-bottom: 2px solid var(--border-color); }
        .list-row { display: grid; grid-template-columns: 2fr 1fr 1fr; padding: 12px; border-bottom: 1px solid var(--border-color); align-items: center; font-size: calc(13px * var(--font-scale)); cursor: pointer; color: var(--text-primary); }
        
        .activity-log { background: var(--card-bg); border-radius: 10px; padding: 15px; box-shadow: 0 2px 10px var(--shadow-color); margin-bottom: 15px; }
        .activity-header { font-size: calc(15px * var(--font-scale)); font-weight: 600; color: var(--text-primary); margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .activity-list { max-height: 400px; overflow-y: auto; }
        .activity-item { padding: 12px; background: var(--bg-color); border-radius: 6px; margin-bottom: 8px; font-size: calc(12px * var(--font-scale)); border-left: 3px solid var(--primary-color); }
        .activity-user { font-weight: 600; color: var(--primary-color); }
        .activity-time { color: var(--text-secondary); font-size: calc(10px * var(--font-scale)); margin-top: 3px; }
        
        /* SCHEDULE VIEW WITH GANTT CHART */
        .schedule-view { background: var(--card-bg); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px var(--shadow-color); margin-bottom: 15px; }
        .schedule-header { background: var(--primary-gradient); color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .schedule-controls { display: flex; gap: 8px; align-items: center; }
        .schedule-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: calc(11px * var(--font-scale)); }
        .schedule-btn.active { background: rgba(255,255,255,0.4); }
        
        .gantt-wrapper { position: relative; background: var(--bg-color); border-radius: 0 0 10px 10px; overflow: auto; max-height: 600px; -webkit-overflow-scrolling: touch; }
        .gantt-container { display: flex; position: relative; min-width: 100%; }
        .gantt-labels-panel { position: sticky; left: 0; z-index: 100; background: var(--card-bg); min-width: 140px; max-width: 140px; box-shadow: 3px 0 8px rgba(0,0,0,0.15); flex-shrink: 0; border-right: 2px solid var(--border-color); }
        .gantt-scrollable { flex: 1; padding: 15px 15px 15px 0; min-width: 0; }
        .gantt-chart-content { position: relative; display: flex; flex-direction: column; }
        .gantt-dates-header { display: flex; background: var(--card-bg); border-bottom: 2px solid var(--border-color); height: 40px; position: sticky; top: 0; z-index: 90; }
        .gantt-label-header { height: 40px; display: flex; align-items: center; padding: 0 10px; font-size: calc(11px * var(--font-scale)); font-weight: 600; color: var(--text-secondary); background: var(--card-bg); border-bottom: 2px solid var(--border-color); position: sticky; top: 0; z-index: 110; }
        .gantt-labels-list { background: var(--card-bg); }
        .gantt-label-row { height: 35px; padding: 0 8px; display: flex; align-items: center; font-size: calc(10px * var(--font-scale)); color: var(--text-primary); font-weight: 500; border-bottom: 1px solid var(--border-color); background: var(--card-bg); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gantt-label-row.project-label { font-weight: 700; font-size: calc(11px * var(--font-scale)); }
        .gantt-label-row.indent { padding-left: 16px; font-size: calc(9px * var(--font-scale)); color: var(--text-secondary); }
        .gantt-timeline-rows { position: relative; background: var(--card-bg); }
        .gantt-timeline-row { height: 35px; position: relative; border-bottom: 1px solid var(--border-color); }
        .gantt-date-cell { display: flex; align-items: center; justify-content: center; text-align: center; border-right: 1px solid rgba(0,0,0,0.05); padding: 2px; font-weight: 500; font-size: calc(9px * var(--font-scale)); color: var(--text-secondary); flex-shrink: 0; }
        .gantt-date-cell.weekend { background: rgba(0,0,0,0.02); color: var(--primary-color); }
        .gantt-date-cell.today { background: rgba(255,68,68,0.1); color: #ff4444; font-weight: 700; }
        .gantt-bar { position: absolute; height: 20px; top: 50%; transform: translateY(-50%); border-radius: 4px; display: flex; align-items: center; padding: 0 6px; font-size: calc(8px * var(--font-scale)); color: white; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; z-index: 2; }
        .gantt-bar:hover { opacity: 0.9; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .gantt-bar.project { background: var(--primary-gradient); font-weight: 600; }
        .gantt-bar.task.completed { background: #7fa67f; }
        .gantt-bar.task.in-progress { background: #d9a673; }
        .gantt-bar.task.not-started { background: #9ca3af; }
        .gantt-bar.task.on-hold { background: #d99ea7; }
        
        .fab-container { 
            position: fixed; 
            bottom: 20px; 
            right: 20px;
            z-index: 999;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .fab { width: 56px; height: 56px; border-radius: 50%; background: var(--primary-gradient); color: white; border: none; font-size: 28px; cursor: pointer; box-shadow: 0 4px 12px var(--shadow-color); }
        .fab:active { transform: scale(0.95); }
        .fab-menu { position: absolute; bottom: 70px; right: 0; display: none; flex-direction: column; gap: 10px; }
        .fab-menu.show { display: flex; }
        .fab-option { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 10px var(--shadow-color); cursor: pointer; white-space: nowrap; font-size: calc(13px * var(--font-scale)); color: var(--text-primary); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: var(--card-bg); border-radius: 12px; width: 100%; max-width: 390px; max-height: 80vh; overflow-y: auto; margin: 0 10px; }
        .modal-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: calc(17px * var(--font-scale)); color: var(--text-primary); }
        .modal-close { font-size: 28px; color: var(--text-secondary); cursor: pointer; }
        .modal-body { padding: 15px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: calc(13px * var(--font-scale)); color: var(--text-secondary); font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: calc(14px * var(--font-scale)); background: var(--bg-color); color: var(--text-primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .modal-footer { padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }
        
        .btn { padding: 10px 18px; border: none; border-radius: 6px; font-size: calc(14px * var(--font-scale)); cursor: pointer; }
        .btn-primary { background: var(--primary-gradient); color: white; }
        .btn-secondary { background: var(--bg-color); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-export { background: #7fa67f; color: white; width: 100%; margin-bottom: 10px; }
        .btn-import { background: #7899b3; color: white; width: 100%; margin-bottom: 10px; }
        
        .user-tag { display: inline-block; padding: 3px 8px; background: var(--primary-light); color: white; border-radius: 4px; font-size: calc(10px * var(--font-scale)); margin-right: 4px; }
        .status-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: calc(10px * var(--font-scale)); font-weight: 500; }
        .status-not-started { background: #e9e9e9; color: #666; }
        .status-in-progress { background: #fff3cd; color: #856404; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-on-hold { background: #f8d7da; color: #721c24; }
        
        .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: var(--card-bg); color: var(--text-primary); padding: 14px 22px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 9999; opacity: 0; transition: opacity 0.3s; font-size: calc(14px * var(--font-scale)); max-width: 90%; text-align: center; }
        .toast.show { opacity: 1; }
        
        @media (min-width: 769px) {
            /* Desktop/Laptop styles */
            .header h1 { font-size: calc(20px * var(--font-scale)); }
            .header { padding: 15px 20px; }
            .stats-bar { grid-template-columns: repeat(3, 1fr); padding: 20px; gap: 15px; max-width: 1400px; margin: 0 auto; }
            .stat-card { padding: 20px; }
            .stat-card h3 { font-size: calc(28px * var(--font-scale)); }
            .stat-card p { font-size: calc(13px * var(--font-scale)); }
            .dashboard-view { 
                display: grid; 
                grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); 
                gap: 20px; 
            }
            .container { 
                padding: 20px; 
                max-width: 1400px; 
                margin: 0 auto;
                width: 100%;
            }
            .list-header, .list-row { grid-template-columns: 3fr 1fr 1fr 1fr 1fr; padding: 15px; }
            .gantt-labels-panel { min-width: 200px; max-width: 200px; }
            .project-card { max-width: 100%; }
            .project-header { padding: 15px 20px; }
            .project-header h3 { font-size: calc(17px * var(--font-scale)); }
            .project-body { padding: 15px 20px; }
            .task-item { padding: 15px; }
            .kanban-column { min-width: 320px; padding: 15px; }
            .kanban-task { padding: 15px; font-size: calc(14px * var(--font-scale)); }
            .settings-panel { max-width: 450px; padding: 30px; }
            .modal-content { max-width: 500px; }
            .fab { width: 60px; height: 60px; font-size: 30px; }
            .fab-container { bottom: 30px; right: 30px; }
            
            /* Better spacing for desktop */
            .view-toggle { padding: 4px; gap: 4px; }
            .view-btn { padding: 8px 12px; font-size: calc(12px * var(--font-scale)); }
            .header-btn { width: 38px; height: 38px; font-size: calc(16px * var(--font-scale)); }
        }
        
        /* Mobile optimization */
        @media (max-width: 768px) {
            html, body {
                overflow-x: hidden;
                width: 100%;
                max-width: 100vw;
                position: relative;
                height: 100%;
            }
            
            .app-container {
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
            }
            
            .header {
                width: 100%;
                max-width: 100vw;
                padding: 10px 12px;
                padding-top: max(25px, env(safe-area-inset-top, 25px));
                padding-bottom: 10px;
                overflow: hidden;
                flex-shrink: 0;
            }
            
            .header-content {
                gap: 6px;
                width: 100%;
            }
            
            .header h1 {
                font-size: calc(15px * var(--font-scale));
            }
            
            .header-left {
                gap: 6px;
                min-width: 0;
                overflow: hidden;
            }
            
            .view-toggle {
                padding: 2px;
                gap: 1px;
            }
            
            .view-btn {
                padding: 4px 5px;
                font-size: calc(9px * var(--font-scale));
            }
            
            .header-btn {
                width: 30px;
                height: 30px;
                font-size: calc(14px * var(--font-scale));
            }
            
            .stats-bar {
                padding: 10px 12px;
                gap: 8px;
                flex-shrink: 0;
            }
            
            .stat-card {
                padding: 8px;
            }
            
            .container { 
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
                overflow-y: auto;
                padding: 10px 12px;
                padding-bottom: 100px;
                flex: 1;
            }
            
            .dashboard-view {
                width: 100%;
                max-width: 100%;
                gap: 12px;
            }
            
            .project-card {
                width: 100%;
                max-width: 100%;
            }
            
            .project-body {
                max-height: 250px;
                padding: 10px;
            }
            
            .task-item {
                padding: 10px;
                margin-bottom: 6px;
            }
            
            .kanban-view {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .list-view {
                width: 100%;
                max-width: 100%;
                overflow-x: hidden;
            }
            
            .sync-status-bar {
                padding: 5px 12px;
                top: calc(75px + env(safe-area-inset-top, 25px));
                font-size: calc(9px * var(--font-scale));
            }
            
            .fab-container {
                bottom: 20px;
                right: 20px;
            }
            
            .fab {
                width: 52px;
                height: 52px;
                font-size: 26px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1>📊 Team Projects</h1>
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="switchView('dashboard')">Dash</button>
                        <button class="view-btn" onclick="switchView('kanban')">Kanban</button>
                        <button class="view-btn" onclick="switchView('list')">List</button>
                        <button class="view-btn" onclick="switchView('schedule')">Schedule</button>
                        <button class="view-btn" onclick="switchView('activity')">Activity</button>
                    </div>
                </div>
                <div class="header-controls">
                    <button class="header-btn" onclick="manualSync()" title="Sync Now">☁️</button>
                    <button class="header-btn" onclick="toggleSettings()" title="Settings">⚙️</button>
                </div>
            </div>
        </div>
        
        <div class="sync-status-bar" id="syncStatusBar">
            <div class="sync-status-left">
                <span class="sync-icon" id="syncIcon">✅</span>
                <span id="syncText">Synced</span>
            </div>
            <span class="sync-badge online" id="onlineStatus">Online</span>
        </div>
        
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <span class="settings-title">Settings</span>
                <button class="close-settings" onclick="toggleSettings()">×</button>
            </div>
            
            <div class="user-profile-section">
                <div class="user-profile-name" id="userProfileName">Loading...</div>
                <div class="user-profile-role">Team Member</div>
                <button class="change-name-btn" onclick="changeUserName()">Change Name</button>
            </div>
            
            <div class="settings-section">
                <label class="settings-label">Auto-Sync</label>
                <div class="auto-sync-options">
                    <div class="toggle-switch">
                        <span style="font-size: 12px;">Enable Auto-Sync</span>
                        <input type="checkbox" id="autoSyncToggle" onchange="toggleAutoSync()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 11px; margin-bottom: 5px;">Sync Interval</label>
                        <select class="sync-interval-select" id="syncInterval" onchange="updateSyncInterval()">
                            <option value="30">Every 30 seconds</option>
                            <option value="60" selected>Every 1 minute</option>
                            <option value="120">Every 2 minutes</option>
                            <option value="300">Every 5 minutes</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <label class="settings-label">Font Size</label>
                <div class="font-size-buttons">
                    <button class="font-btn" onclick="setFontSize('small')" id="font-small">S</button>
                    <button class="font-btn" onclick="setFontSize('normal')" id="font-normal">M</button>
                    <button class="font-btn" onclick="setFontSize('large')" id="font-large">L</button>
                    <button class="font-btn" onclick="setFontSize('xlarge')" id="font-xlarge">XL</button>
                </div>
            </div>
            
            <div class="settings-section">
                <label class="settings-label">Page Contrast</label>
                <div class="contrast-buttons">
                    <button class="contrast-btn" onclick="setContrast('normal')" id="contrast-normal">Normal</button>
                    <button class="contrast-btn" onclick="setContrast('low')" id="contrast-low">Low</button>
                    <button class="contrast-btn" onclick="setContrast('high')" id="contrast-high">High</button>
                    <button class="contrast-btn" onclick="setContrast('extra')" id="contrast-extra">Extra</button>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="toggle-switch">
                    <span class="settings-label" style="margin: 0;">Night Mode</span>
                    <input type="checkbox" id="nightToggle" onchange="toggleDayNight()">
                </div>
            </div>
            
            <div class="settings-section">
                <label class="settings-label">Color Theme</label>
                <div class="theme-grid">
                    <button class="theme-option-btn" onclick="setTheme('charcoal')"><span class="color-dot" style="background:#2a2a2f"></span>Charcoal</button>
                    <button class="theme-option-btn" onclick="setTheme('navy')"><span class="color-dot" style="background:#6b7c93"></span>Navy</button>
                    <button class="theme-option-btn" onclick="setTheme('steel')"><span class="color-dot" style="background:#7899b3"></span>Steel</button>
                    <button class="theme-option-btn" onclick="setTheme('slate')"><span class="color-dot" style="background:#708090"></span>Slate</button>
                    <button class="theme-option-btn" onclick="setTheme('sage')"><span class="color-dot" style="background:#87a087"></span>Sage</button>
                    <button class="theme-option-btn" onclick="setTheme('olive')"><span class="color-dot" style="background:#8b8c7a"></span>Olive</button>
                    <button class="theme-option-btn" onclick="setTheme('forest')"><span class="color-dot" style="background:#6f8f6f"></span>Forest</button>
                    <button class="theme-option-btn" onclick="setTheme('plum')"><span class="color-dot" style="background:#8b7a8f"></span>Plum</button>
                    <button class="theme-option-btn" onclick="setTheme('mauve')"><span class="color-dot" style="background:#9b8b9f"></span>Mauve</button>
                    <button class="theme-option-btn" onclick="setTheme('wisteria')"><span class="color-dot" style="background:#8b88a8"></span>Wisteria</button>
                    <button class="theme-option-btn" onclick="setTheme('taupe')"><span class="color-dot" style="background:#8b8680"></span>Taupe</button>
                    <button class="theme-option-btn" onclick="setTheme('mushroom')"><span class="color-dot" style="background:#9b9088"></span>Mushroom</button>
                    <button class="theme-option-btn" onclick="setTheme('cocoa')"><span class="color-dot" style="background:#8b7b73"></span>Cocoa</button>
                    <button class="theme-option-btn" onclick="setTheme('dusty-rose')"><span class="color-dot" style="background:#ba9a9f"></span>D.Rose</button>
                    <button class="theme-option-btn" onclick="setTheme('coral')"><span class="color-dot" style="background:#c99a93"></span>Coral</button>
                    <button class="theme-option-btn" onclick="setTheme('stone')"><span class="color-dot" style="background:#9b9893"></span>Stone</button>
                    <button class="theme-option-btn" onclick="setTheme('ash')"><span class="color-dot" style="background:#888"></span>Ash</button>
                    <button class="theme-option-btn" onclick="setTheme('denim')"><span class="color-dot" style="background:#6b87a8"></span>Denim</button>
                </div>
            </div>
            
            <div class="settings-section">
                <label class="settings-label">Data Management</label>
                <button class="btn btn-export" onclick="exportData()">📤 Export Data</button>
                <label class="btn btn-import" style="display: block; text-align: center; cursor: pointer;">
                    📥 Import Data
                    <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                </label>
            </div>
            
            <div class="settings-section">
                <label class="settings-label">Cloud Sync Setup</label>
                <button class="btn btn-secondary" onclick="resetApiKey()" style="width: 100%; margin-bottom: 8px;">🔑 Change API Key</button>
                <div style="font-size: 10px; color: var(--text-secondary); line-height: 1.4;">
                    Get free API key from <a href="https://jsonbin.io" target="_blank" style="color: var(--primary-color);">jsonbin.io</a>
                </div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-card">
                <h3 id="totalProjects">0</h3>
                <p>Projects</p>
            </div>
            <div class="stat-card">
                <h3 id="totalTasks">0</h3>
                <p>Tasks</p>
            </div>
            <div class="stat-card">
                <h3 id="todayTasks">0</h3>
                <p>Today</p>
            </div>
        </div>

        <div class="container" id="mainContent"></div>
    </div>

    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <div class="fab-option" onclick="showTaskModal()">
                <span>📋</span>New Task
            </div>
            <div class="fab-option" onclick="showProjectModal()">
                <span>📁</span>New Project
            </div>
            <div class="fab-option" onclick="showUserModal()">
                <span>👥</span>Manage Users
            </div>
        </div>
        <button class="fab" onclick="toggleFabMenu()">+</button>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="taskModalTitle">New Task</h2>
                <span class="modal-close" onclick="closeModal('taskModal')">×</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Task Name *</label>
                    <input type="text" id="taskName" placeholder="Enter task name">
                </div>
                <div class="form-group">
                    <label>Project *</label>
                    <select id="taskProject"></select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Assignee</label>
                        <select id="taskAssignee"></select>
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="taskPriority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="taskStart">
                    </div>
                    <div class="form-group">
                        <label>Due Date *</label>
                        <input type="date" id="taskDue">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="taskDescription" placeholder="Task description..." rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTask()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="projectModalTitle">New Project</h2>
                <span class="modal-close" onclick="closeModal('projectModal')">×</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project Name *</label>
                    <input type="text" id="projectName" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="projectDescription" placeholder="Project description..." rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="projectStart">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="projectEnd">
                    </div>
                </div>
                <div class="form-group">
                    <label>Project Lead</label>
                    <select id="projectLead"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Team Members</h2>
                <span class="modal-close" onclick="closeModal('userModal')">×</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Current Team Members</label>
                    <div id="userList" style="margin: 10px 0;"></div>
                </div>
                <div class="form-group">
                    <label>Add New Member</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="newUserName" placeholder="Enter name" style="flex: 1;">
                        <button class="btn btn-primary" onclick="addUser()">Add</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('userModal')">Done</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        class EnhancedCloudSync {
            constructor() {
                this.binId = '68e06018d0ea881f4094852b';
                this.apiKey = localStorage.getItem('syncApiKey') || '';
                this.baseUrl = 'https://api.jsonbin.io/v3';
                this.isSyncing = false;
                this.lastSyncTime = null;
                this.autoSyncInterval = null;
            }
            
            async setup() {
                if (!this.apiKey) {
                    const apiKey = prompt('🔑 Enter your JSONBin API Key:\n\nGet one free at jsonbin.io');
                    if (!apiKey) {
                        showToast('Sync cancelled. Set it up anytime from Settings.');
                        return false;
                    }
                    this.apiKey = apiKey.trim();
                    localStorage.setItem('syncApiKey', this.apiKey);
                    
                    try {
                        const response = await fetch(`${this.baseUrl}/b/${this.binId}/latest`, {
                            headers: { 'X-Master-Key': this.apiKey }
                        });
                        if (!response.ok) throw new Error('Invalid API key');
                        showToast('✅ Sync connected successfully!');
                        return true;
                    } catch (error) {
                        showToast('❌ Invalid API key. Please try again.');
                        localStorage.removeItem('syncApiKey');
                        this.apiKey = '';
                        return false;
                    }
                }
                return true;
            }
            
            async push(silent = false) {
                if (!await this.setup()) return false;
                if (this.isSyncing) return false;
                
                this.isSyncing = true;
                updateSyncStatus('syncing', 'Syncing to cloud...');
                
                try {
                    const dataToSync = {
                        ...data,
                        lastUpdated: new Date().toISOString(),
                        lastUpdatedBy: data.currentUser,
                        syncVersion: (data.syncVersion || 0) + 1
                    };
                    
                    const response = await fetch(`${this.baseUrl}/b/${this.binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': this.apiKey
                        },
                        body: JSON.stringify(dataToSync)
                    });
                    
                    if (response.ok) {
                        this.lastSyncTime = new Date();
                        data.syncVersion = dataToSync.syncVersion;
                        data.lastUpdated = dataToSync.lastUpdated;
                        updateSyncStatus('synced', `Synced ${this.getTimeAgo()}`);
                        if (!silent) showToast('✅ Saved to cloud');
                        return true;
                    } else {
                        updateSyncStatus('error', 'Sync failed');
                        showToast('⚠️ Sync failed. Try again.');
                        return false;
                    }
                } catch (error) {
                    updateSyncStatus('offline', 'Offline');
                    if (!silent) showToast('📵 No internet connection');
                    return false;
                } finally {
                    this.isSyncing = false;
                }
            }
            
            async pull(silent = false) {
                if (!await this.setup()) return false;
                if (this.isSyncing) return false;
                
                this.isSyncing = true;
                updateSyncStatus('syncing', 'Loading from cloud...');
                
                try {
                    const response = await fetch(`${this.baseUrl}/b/${this.binId}/latest`, {
                        headers: { 'X-Master-Key': this.apiKey }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const cloudData = result.record;
                        this.applyCloudData(cloudData);
                        this.lastSyncTime = new Date();
                        updateSyncStatus('synced', `Synced ${this.getTimeAgo()}`);
                        if (!silent) showToast('☁️ Loaded from cloud');
                        return true;
                    } else {
                        updateSyncStatus('error', 'Sync failed');
                        showToast('⚠️ Failed to load from cloud');
                        return false;
                    }
                } catch (error) {
                    updateSyncStatus('offline', 'Offline');
                    if (!silent) showToast('📵 No internet connection');
                    return false;
                } finally {
                    this.isSyncing = false;
                }
            }
            
            applyCloudData(cloudData) {
                const oldView = data.currentView;
                data = { ...data, ...cloudData };
                data.currentView = oldView;
                
                localStorage.setItem('teamProjectData', JSON.stringify(data));
                applyThemeSettings();
                renderView();
                updateStats();
                updateUserProfile();
            }
            
            getTimeAgo() {
                if (!this.lastSyncTime) return 'just now';
                const seconds = Math.floor((new Date() - this.lastSyncTime) / 1000);
                if (seconds < 60) return 'just now';
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes}m ago`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours}h ago`;
                return `${Math.floor(hours / 24)}d ago`;
            }
            
            startAutoSync(intervalSeconds = 60) {
                this.stopAutoSync();
                this.autoSyncInterval = setInterval(() => {
                    if (navigator.onLine && !this.isSyncing) {
                        this.pull(true);
                    }
                }, intervalSeconds * 1000);
                addActivityLog('System', 'Auto-sync enabled', 'system');
            }
            
            stopAutoSync() {
                if (this.autoSyncInterval) {
                    clearInterval(this.autoSyncInterval);
                    this.autoSyncInterval = null;
                }
            }
        }

        const cloudSync = new EnhancedCloudSync();

        let data = {
            currentUser: '',
            currentView: 'dashboard',
            projects: [],
            tasks: [],
            users: ['John Doe', 'Jane Smith', 'Mike Johnson', 'Sarah Williams', 'Tom Brown', 'Emily Davis'],
            activityLog: [],
            theme: 'charcoal',
            nightMode: false,
            contrast: 'normal',
            fontSize: 'normal',
            autoSyncEnabled: false,
            autoSyncInterval: 60,
            lastUpdated: null,
            syncVersion: 0,
            ganttViewMode: 'week'
        };

        let editingTaskId = null;
        let editingProjectId = null;
        let draggedElement = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            initializeApp();
            renderView();
            updateStats();
            setupOnlineDetection();
            applyThemeSettings();
            updateUserProfile();
            
            if (data.autoSyncEnabled) {
                document.getElementById('autoSyncToggle').checked = true;
                cloudSync.startAutoSync(data.autoSyncInterval);
            }
            
            document.getElementById('syncInterval').value = data.autoSyncInterval;
        });
        
        function setupOnlineDetection() {
            window.addEventListener('online', () => {
                document.getElementById('onlineStatus').textContent = 'Online';
                document.getElementById('onlineStatus').className = 'sync-badge online';
                showToast('📶 Back online');
                if (data.autoSyncEnabled) {
                    cloudSync.pull(true);
                }
            });
            
            window.addEventListener('offline', () => {
                document.getElementById('onlineStatus').textContent = 'Offline';
                document.getElementById('onlineStatus').className = 'sync-badge offline';
                showToast('📵 You are offline');
                updateSyncStatus('offline', 'Offline mode');
            });
            
            // Set initial online status without showing sync bar
            if (navigator.onLine) {
                document.getElementById('onlineStatus').textContent = 'Online';
                document.getElementById('onlineStatus').className = 'sync-badge online';
            } else {
                document.getElementById('onlineStatus').textContent = 'Offline';
                document.getElementById('onlineStatus').className = 'sync-badge offline';
            }
        }
        
        function updateSyncStatus(status, text) {
            const statusBar = document.getElementById('syncStatusBar');
            const icon = document.getElementById('syncIcon');
            const textEl = document.getElementById('syncText');
            
            statusBar.classList.add('show');
            textEl.textContent = text;
            
            switch(status) {
                case 'syncing':
                    icon.textContent = '🔄';
                    icon.classList.add('syncing');
                    break;
                case 'synced':
                    icon.textContent = '✅';
                    icon.classList.remove('syncing');
                    // Auto-hide after 2 seconds
                    setTimeout(() => statusBar.classList.remove('show'), 2000);
                    break;
                case 'error':
                    icon.textContent = '⚠️';
                    icon.classList.remove('syncing');
                    // Auto-hide error after 3 seconds
                    setTimeout(() => statusBar.classList.remove('show'), 3000);
                    break;
                case 'offline':
                    icon.textContent = '📵';
                    icon.classList.remove('syncing');
                    // Auto-hide offline status after 3 seconds
                    setTimeout(() => statusBar.classList.remove('show'), 3000);
                    break;
            }
        }
        
        function toggleAutoSync() {
            data.autoSyncEnabled = document.getElementById('autoSyncToggle').checked;
            
            if (data.autoSyncEnabled) {
                cloudSync.startAutoSync(data.autoSyncInterval);
                showToast('✅ Auto-sync enabled');
            } else {
                cloudSync.stopAutoSync();
                showToast('⏸️ Auto-sync disabled');
                addActivityLog('System', 'Auto-sync disabled', 'system');
            }
            
            saveData();
        }
        
        function updateSyncInterval() {
            data.autoSyncInterval = parseInt(document.getElementById('syncInterval').value);
            
            if (data.autoSyncEnabled) {
                cloudSync.startAutoSync(data.autoSyncInterval);
                showToast(`🔄 Sync interval: ${data.autoSyncInterval}s`);
            }
            
            saveData();
        }
        
        function manualSync() {
            const action = confirm('Sync Options:\n\n✅ OK = Pull from cloud (get latest)\n❌ Cancel = Push to cloud (save yours)');
            if (action) {
                cloudSync.pull();
            } else {
                cloudSync.push();
            }
        }
        
        function resetApiKey() {
            if (confirm('This will remove your current API key. Continue?')) {
                localStorage.removeItem('syncApiKey');
                cloudSync.apiKey = '';
                cloudSync.stopAutoSync();
                data.autoSyncEnabled = false;
                document.getElementById('autoSyncToggle').checked = false;
                showToast('🔑 API key removed. Set up again to sync.');
                saveData();
            }
        }
        
        function changeUserName() {
            const newName = prompt('Enter your name:', data.currentUser);
            if (newName && newName.trim()) {
                const oldName = data.currentUser;
                data.currentUser = newName.trim();
                
                if (!data.users.includes(data.currentUser)) {
                    data.users.push(data.currentUser);
                }
                
                saveData();
                updateUserProfile();
                addActivityLog(data.currentUser, `Changed name from ${oldName}`, 'system');
                showToast(`👤 Name changed to ${data.currentUser}`);
            }
        }
        
        function updateUserProfile() {
            document.getElementById('userProfileName').textContent = data.currentUser || 'Set Your Name';
        }
        
        function addActivityLog(user, action, type = 'task') {
            const activity = {
                id: Date.now(),
                user: user,
                action: action,
                type: type,
                timestamp: new Date().toISOString()
            };
            
            data.activityLog.unshift(activity);
            
            if (data.activityLog.length > 100) {
                data.activityLog = data.activityLog.slice(0, 100);
            }
            
            saveData();
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function applyThemeSettings() {
            document.body.className = '';
            if (data.theme) document.body.classList.add('theme-' + data.theme);
            if (data.nightMode) {
                document.body.classList.add('night-mode');
                document.getElementById('nightToggle').checked = true;
            }
            if (data.contrast && data.contrast !== 'normal') {
                if (data.contrast === 'low') document.body.classList.add('low-contrast');
                else if (data.contrast === 'high') document.body.classList.add('high-contrast');
                else if (data.contrast === 'extra') document.body.classList.add('extra-high-contrast');
            }
            if (data.fontSize && data.fontSize !== 'normal') {
                document.body.classList.add('font-' + data.fontSize);
            }
            
            setContrast(data.contrast);
            setFontSize(data.fontSize);
        }
        
        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('show');
        }
        
        function setFontSize(size) {
            document.body.classList.remove('font-small', 'font-large', 'font-xlarge');
            document.querySelectorAll('.font-btn').forEach(btn => btn.classList.remove('active'));
            
            if (size === 'small') {
                document.body.classList.add('font-small');
                document.getElementById('font-small').classList.add('active');
            } else if (size === 'large') {
                document.body.classList.add('font-large');
                document.getElementById('font-large').classList.add('active');
            } else if (size === 'xlarge') {
                document.body.classList.add('font-xlarge');
                document.getElementById('font-xlarge').classList.add('active');
            } else {
                document.getElementById('font-normal').classList.add('active');
            }
            
            data.fontSize = size;
            saveData();
        }
        
        function setContrast(level) {
            document.body.classList.remove('low-contrast', 'high-contrast', 'extra-high-contrast');
            document.querySelectorAll('.contrast-btn').forEach(btn => btn.classList.remove('active'));
            
            if (level === 'low') {
                document.body.classList.add('low-contrast');
                document.getElementById('contrast-low').classList.add('active');
            } else if (level === 'high') {
                document.body.classList.add('high-contrast');
                document.getElementById('contrast-high').classList.add('active');
            } else if (level === 'extra') {
                document.body.classList.add('extra-high-contrast');
                document.getElementById('contrast-extra').classList.add('active');
            } else {
                document.getElementById('contrast-normal').classList.add('active');
            }
            
            data.contrast = level;
            saveData();
        }

        function loadData() {
            const saved = localStorage.getItem('teamProjectData');
            if (saved) {
                const parsed = JSON.parse(saved);
                data = { ...data, ...parsed };
                
                if (!data.currentUser) {
                    data.currentUser = prompt('Welcome! Please enter your name:') || 'Team Member';
                    if (!data.users.includes(data.currentUser)) {
                        data.users.push(data.currentUser);
                    }
                    saveData();
                }
            } else {
                data.currentUser = prompt('Welcome! Please enter your name:') || 'Team Member';
                if (!data.users.includes(data.currentUser)) {
                    data.users.push(data.currentUser);
                }
                createSampleData();
            }
        }

        function saveData() {
            data.lastUpdated = new Date().toISOString();
            localStorage.setItem('teamProjectData', JSON.stringify(data));
        }
        
        function exportData() {
            const exportData = { 
                ...data, 
                exportDate: new Date().toISOString(),
                exportedBy: data.currentUser
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'team-projects-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            addActivityLog(data.currentUser, 'Exported data', 'system');
            showToast('📤 Data exported successfully');
            toggleSettings();
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (confirm('Replace all current data? (Cancel to merge)')) {
                            data = { ...data, ...importedData, currentUser: data.currentUser };
                            addActivityLog(data.currentUser, 'Imported data (replaced)', 'system');
                        } else {
                            data.projects = [...data.projects, ...importedData.projects];
                            data.tasks = [...data.tasks, ...importedData.tasks];
                            data.users = [...new Set([...data.users, ...importedData.users])];
                            data.activityLog = [...data.activityLog, ...(importedData.activityLog || [])]
                                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                                .slice(0, 100);
                            addActivityLog(data.currentUser, 'Imported data (merged)', 'system');
                        }
                        saveData();
                        renderView();
                        updateStats();
                        showToast('✅ Data imported successfully!');
                        toggleSettings();
                    } catch (error) {
                        showToast('❌ Error importing data');
                    }
                };
                reader.readAsText(file);
            }
        }

        function createSampleData() {
            const today = new Date().toISOString().split('T')[0];
            const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            data.projects = [
                { 
                    id: 1, 
                    name: 'Website Redesign', 
                    description: 'Complete overhaul of company website', 
                    startDate: today, 
                    endDate: nextWeek, 
                    lead: 'Jane Smith',
                    createdBy: data.currentUser,
                    createdAt: new Date().toISOString()
                }
            ];
            
            data.tasks = [
                { 
                    id: 1, 
                    projectId: 1, 
                    name: 'Design Homepage Mockup', 
                    description: 'Create initial design concepts', 
                    assignee: 'Emily Davis', 
                    priority: 'High', 
                    status: 'In Progress', 
                    startDate: today, 
                    dueDate: nextWeek, 
                    progress: 50,
                    createdBy: data.currentUser,
                    createdAt: new Date().toISOString()
                }
            ];
            
            addActivityLog('System', 'Created sample project and task', 'system');
            saveData();
        }

        function toggleDayNight() {
            document.body.classList.toggle('night-mode');
            data.nightMode = document.body.classList.contains('night-mode');
            document.getElementById('nightToggle').checked = data.nightMode;
            saveData();
        }

        function setTheme(themeName) {
            document.body.className = document.body.className.replace(/theme-[a-z-]+/g, '').trim();
            if (themeName) document.body.classList.add('theme-' + themeName);
            if (data.nightMode) document.body.classList.add('night-mode');
            if (data.contrast && data.contrast !== 'normal') {
                if (data.contrast === 'low') document.body.classList.add('low-contrast');
                else if (data.contrast === 'high') document.body.classList.add('high-contrast');
                else if (data.contrast === 'extra') document.body.classList.add('extra-high-contrast');
            }
            if (data.fontSize && data.fontSize !== 'normal') document.body.classList.add('font-' + data.fontSize);
            data.theme = themeName;
            saveData();
        }

        function initializeApp() {
            populateDropdowns();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('taskStart').value = today;
            document.getElementById('projectStart').value = today;
        }

        function populateDropdowns() {
            const userSelects = ['taskAssignee', 'projectLead'];
            userSelects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Unassigned</option>';
                    data.users.forEach(user => {
                        select.innerHTML += `<option value="${user}">${user}</option>`;
                    });
                }
            });

            const projectSelect = document.getElementById('taskProject');
            if (projectSelect) {
                projectSelect.innerHTML = '<option value="">Select Project</option>';
                data.projects.forEach(project => {
                    projectSelect.innerHTML += `<option value="${project.id}">${project.name}</option>`;
                });
            }
        }

        function switchView(view) {
            data.currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderView();
        }

        function renderView() {
            const content = document.getElementById('mainContent');
            switch(data.currentView) {
                case 'dashboard': renderDashboard(content); break;
                case 'kanban': renderKanban(content); break;
                case 'list': renderList(content); break;
                case 'schedule': renderSchedule(content); break;
                case 'activity': renderActivity(content); break;
            }
        }
        
        function renderSchedule(container) {
            const scheduleData = generateMasterSchedule();
            if (!data.ganttViewMode) data.ganttViewMode = 'week';
            
            let html = `
                <div class="schedule-view">
                    <div class="schedule-header">
                        <div>
                            <h3 style="font-size: 14px; margin-bottom: 2px;">Master Project Schedule</h3>
                            <div style="font-size: 11px; opacity: 0.9;">All projects and tasks combined</div>
                        </div>
                        <div class="schedule-controls">
                            <button class="schedule-btn ${data.ganttViewMode === 'day' ? 'active' : ''}" onclick="setGanttView('day')">Day</button>
                            <button class="schedule-btn ${data.ganttViewMode === 'week' ? 'active' : ''}" onclick="setGanttView('week')">Week</button>
                            <button class="schedule-btn ${data.ganttViewMode === 'month' ? 'active' : ''}" onclick="setGanttView('month')">Month</button>
                        </div>
                    </div>
                    ${renderGanttChart(scheduleData, data.ganttViewMode)}
                </div>
            `;
            container.innerHTML = html;
        }
        
        function setGanttView(mode) {
            data.ganttViewMode = mode;
            saveData();
            renderView();
        }
        
        function generateMasterSchedule() {
            const allItems = [];
            let earliestStart = null, latestEnd = null;
            
            data.projects.forEach(project => {
                const projectTasks = data.tasks.filter(t => t.projectId === project.id);
                const projectStart = project.startDate || new Date().toISOString().split('T')[0];
                const projectEnd = project.endDate || projectStart;
                
                allItems.push({ type: 'project', id: project.id, name: project.name, start: projectStart, end: projectEnd });
                
                projectTasks.forEach(task => {
                    allItems.push({
                        type: 'task', id: task.id, projectId: project.id, name: task.name,
                        start: task.startDate || task.dueDate, end: task.dueDate,
                        status: task.status || 'Not Started', assignee: task.assignee
                    });
                });
                
                if (!earliestStart || projectStart < earliestStart) earliestStart = projectStart;
                if (!latestEnd || projectEnd > latestEnd) latestEnd = projectEnd;
            });
            
            const oneYearLater = new Date(earliestStart);
            oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);
            const oneYearStr = oneYearLater.toISOString().split('T')[0];
            if (latestEnd < oneYearStr) latestEnd = oneYearStr;
            
            return {
                items: allItems,
                earliestStart: earliestStart || new Date().toISOString().split('T')[0],
                latestEnd: latestEnd || new Date().toISOString().split('T')[0]
            };
        }
        
        function renderGanttChart(scheduleData, viewMode = 'week') {
            const { items, earliestStart, latestEnd } = scheduleData;
            const startDate = new Date(earliestStart);
            const endDate = new Date(latestEnd);
            
            let pixelsPerUnit, dateHeaders;
            if (viewMode === 'day') {
                pixelsPerUnit = 30;
                dateHeaders = generateDayHeaders(startDate, endDate);
            } else if (viewMode === 'month') {
                pixelsPerUnit = 100;
                dateHeaders = generateMonthHeaders(startDate, endDate);
            } else {
                pixelsPerUnit = 60;
                dateHeaders = generateWeekHeaders(startDate, endDate);
            }
            
            const chartWidth = dateHeaders.length * pixelsPerUnit;
            const labels = [];
            const timelineRows = [];
            
            const projects = items.filter(i => i.type === 'project');
            projects.forEach(project => {
                labels.push({ text: project.name, indent: false, isProject: true });
                const projectStart = new Date(project.start);
                const projectEnd = new Date(project.end);
                const projectStartPos = calculatePosition(projectStart, startDate, viewMode) * pixelsPerUnit;
                const projectDuration = (calculatePosition(projectEnd, startDate, viewMode) - calculatePosition(projectStart, startDate, viewMode) + 1) * pixelsPerUnit;
                
                const dateRangeText = `${project.name}: ${formatDateRange(project.start, project.end)}`;
                
                timelineRows.push({
                    type: 'project',
                    left: projectStartPos,
                    width: Math.max(pixelsPerUnit/2, projectDuration),
                    name: dateRangeText
                });
                
                const projectTasks = items.filter(i => i.type === 'task' && i.projectId === project.id);
                projectTasks.forEach(task => {
                    labels.push({ text: task.name, indent: true, isProject: false });
                    const taskStart = new Date(task.start);
                    const taskEnd = new Date(task.end);
                    const taskStartPos = calculatePosition(taskStart, startDate, viewMode) * pixelsPerUnit;
                    const taskDuration = (calculatePosition(taskEnd, startDate, viewMode) - calculatePosition(taskStart, startDate, viewMode) + 1) * pixelsPerUnit;
                    const statusClass = task.status.toLowerCase().replace(' ', '-');
                    
                    const taskDateRange = formatDateRange(task.start, task.end);
                    
                    timelineRows.push({
                        type: 'task',
                        left: taskStartPos,
                        width: Math.max(pixelsPerUnit/2, taskDuration),
                        name: taskDateRange,
                        statusClass: statusClass
                    });
                });
            });
            
            let html = '<div class="gantt-wrapper"><div class="gantt-container">';
            html += '<div class="gantt-labels-panel"><div class="gantt-label-header">Tasks / Projects</div><div class="gantt-labels-list">';
            labels.forEach(label => {
                html += `<div class="gantt-label-row ${label.indent ? 'indent' : ''} ${label.isProject ? 'project-label' : ''}">${label.text}</div>`;
            });
            html += '</div></div>';
            
            html += '<div class="gantt-scrollable"><div class="gantt-chart-content" style="width: ' + chartWidth + 'px;"><div class="gantt-dates-header">';
            dateHeaders.forEach(header => {
                html += `<div class="gantt-date-cell ${header.isWeekend ? 'weekend' : ''} ${header.isToday ? 'today' : ''}" style="width: ${pixelsPerUnit}px;">${header.label}</div>`;
            });
            html += '</div><div class="gantt-timeline-rows">';
            
            timelineRows.forEach(row => {
                html += '<div class="gantt-timeline-row">';
                if (row.type === 'project') {
                    html += `<div class="gantt-bar project" style="left: ${row.left}px; width: ${row.width}px;">${row.name}</div>`;
                } else {
                    html += `<div class="gantt-bar task ${row.statusClass}" style="left: ${row.left}px; width: ${row.width}px;">${row.name}</div>`;
                }
                html += '</div>';
            });
            
            html += '</div></div></div></div></div>';
            return html;
        }
        
        function formatDateRange(startDateStr, endDateStr) {
            const start = new Date(startDateStr);
            const end = new Date(endDateStr);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            if (start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) {
                return `${start.getDate()}-${end.getDate()} ${months[start.getMonth()]}`;
            } else if (start.getFullYear() === end.getFullYear()) {
                return `${start.getDate()} ${months[start.getMonth()]}-${end.getDate()} ${months[end.getMonth()]}`;
            } else {
                return `${start.getDate()} ${months[start.getMonth()]} ${start.getFullYear().toString().slice(2)}-${end.getDate()} ${months[end.getMonth()]} ${end.getFullYear().toString().slice(2)}`;
            }
        }
        
        function generateDayHeaders(startDate, endDate) {
            const headers = [], current = new Date(startDate), today = new Date();
            today.setHours(0, 0, 0, 0);
            while (current <= endDate) {
                headers.push({
                    label: `${current.getDate()}<br><span style="font-size:9px;">${current.toLocaleDateString('en', {month:'short'})}</span>`,
                    isWeekend: current.getDay() === 0 || current.getDay() === 6,
                    isToday: current.getTime() === today.getTime()
                });
                current.setDate(current.getDate() + 1);
            }
            return headers;
        }
        
        function generateWeekHeaders(startDate, endDate) {
            const headers = [], current = new Date(startDate), today = new Date();
            current.setDate(current.getDate() - current.getDay());
            while (current <= endDate) {
                const weekEnd = new Date(current);
                weekEnd.setDate(weekEnd.getDate() + 6);
                const monthName = current.toLocaleDateString('en', {month:'short'});
                headers.push({
                    label: `${current.getDate()}-${weekEnd.getDate()}<br><span style="font-size:9px;">${monthName}</span>`,
                    isWeekend: false,
                    isToday: today >= current && today <= weekEnd
                });
                current.setDate(current.getDate() + 7);
            }
            return headers;
        }
        
        function generateMonthHeaders(startDate, endDate) {
            const headers = [], current = new Date(startDate.getFullYear(), startDate.getMonth(), 1), today = new Date();
            while (current <= endDate) {
                headers.push({
                    label: current.toLocaleDateString('en', { month: 'short', year: 'numeric' }),
                    isWeekend: false,
                    isToday: current.getFullYear() === today.getFullYear() && current.getMonth() === today.getMonth()
                });
                current.setMonth(current.getMonth() + 1);
            }
            return headers;
        }
        
        function calculatePosition(date, startDate, viewMode) {
            const diffTime = date - startDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            if (viewMode === 'day') return diffDays;
            if (viewMode === 'week') return Math.floor(diffDays / 7);
            return (date.getFullYear() - startDate.getFullYear()) * 12 + (date.getMonth() - startDate.getMonth());
        }
        
        function renderActivity(container) {
            let html = '<div class="activity-log">';
            html += '<div class="activity-header">';
            html += '<span>📜 Activity Log</span>';
            html += '<span style="font-size: 11px; color: var(--text-secondary);">' + data.activityLog.length + ' events</span>';
            html += '</div>';
            html += '<div class="activity-list">';
            
            if (data.activityLog.length === 0) {
                html += '<p style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">No activity yet</p>';
            } else {
                data.activityLog.forEach(activity => {
                    const time = new Date(activity.timestamp);
                    const timeStr = formatActivityTime(time);
                    
                    html += `
                        <div class="activity-item">
                            <div class="activity-action">
                                <span class="activity-user">${activity.user}</span>
                                ${activity.action}
                            </div>
                            <div class="activity-time">${timeStr}</div>
                        </div>
                    `;
                });
            }
            
            html += '</div></div>';
            container.innerHTML = html;
        }
        
        function formatActivityTime(date) {
            const now = new Date();
            const diff = now - date;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (seconds < 60) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        function renderDashboard(container) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let html = '<div class="dashboard-view">';
            data.projects.forEach(project => {
                const projectTasks = data.tasks.filter(t => t.projectId === project.id);
                const projectDateRange = project.startDate && project.endDate ? formatDateRange(project.startDate, project.endDate) : '';
                
                html += `
                    <div class="project-card">
                        <div class="project-header">
                            <div>
                                <h3>${project.name}</h3>
                                <div style="font-size: 11px; opacity: 0.9;">
                                    Lead: ${project.lead || 'Unassigned'}
                                    ${projectDateRange ? ` | ${projectDateRange}` : ''}
                                </div>
                            </div>
                            <div class="project-actions">
                                <button class="action-btn" onclick="editProject(${project.id})">Edit</button>
                                <button class="action-btn" onclick="deleteProject(${project.id})">Del</button>
                            </div>
                        </div>
                        <div class="project-body">`;
                
                if (projectTasks.length === 0) {
                    html += '<p style="color: #999; text-align: center; padding: 20px;">No tasks yet</p>';
                } else {
                    projectTasks.forEach(task => {
                        const dueDate = new Date(task.dueDate);
                        dueDate.setHours(0, 0, 0, 0);
                        const isDueToday = dueDate.getTime() === today.getTime();
                        const isOverdue = dueDate < today && task.status !== 'Completed';
                        const isInProgress = task.status === 'In Progress';
                        
                        let statusIndicator = '';
                        let taskClass = '';
                        
                        if (task.status === 'Completed') {
                            taskClass = 'completed';
                        } else if (isDueToday || isOverdue) {
                            taskClass = isDueToday ? 'due-today' : 'overdue';
                            statusIndicator = '<span class="status-indicator due">DUE</span>';
                        } else if (isInProgress) {
                            statusIndicator = '<span class="status-indicator in-progress">IN PROGRESS</span>';
                        }
                        
                        const taskDateRange = formatDateRange(task.startDate || task.dueDate, task.dueDate);
                        
                        html += `
                            <div class="task-item ${taskClass}">
                                <div class="task-actions">
                                    <button class="task-btn" onclick="editTask(${task.id})">Edit</button>
                                    <button class="task-btn" onclick="deleteTask(${task.id})">Del</button>
                                </div>
                                <div style="font-weight: 500; margin-bottom: 3px; font-size: 13px;">${task.name}${statusIndicator}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">
                                    <span class="user-tag">${task.assignee || 'Unassigned'}</span>
                                    📅 ${taskDateRange} | ${task.priority}
                                </div>
                                <div class="task-meta">Created by ${task.createdBy || 'Unknown'}</div>
                            </div>`;
                    });
                }
                html += '</div></div>';
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function renderKanban(container) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const dueTasks = data.tasks.filter(t => {
                const dueDate = new Date(t.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                return dueDate <= today && t.status !== 'Completed';
            });
            
            const inProgressTasks = data.tasks.filter(t => t.status === 'In Progress');
            const comingActionTasks = data.tasks.filter(t => {
                const dueDate = new Date(t.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                return (t.status === 'Not Started' || !t.status) && dueDate > today;
            });
            
            const columns = [
                { title: 'Due', tasks: dueTasks, status: 'Due' },
                { title: 'In Progress', tasks: inProgressTasks, status: 'In Progress' },
                { title: 'Coming Action', tasks: comingActionTasks, status: 'Not Started' }
            ];
            
            let html = '<div class="kanban-view">';
            columns.forEach(column => {
                html += `<div class="kanban-column"><div class="kanban-header">${column.title} (${column.tasks.length})</div>
                    <div class="kanban-tasks" data-status="${column.status}">`;
                column.tasks.forEach(task => {
                    const project = data.projects.find(p => p.id === task.projectId);
                    const dateRange = formatDateRange(task.startDate || task.dueDate, task.dueDate);
                    html += `
                        <div class="kanban-task" draggable="true" data-task-id="${task.id}" ondragstart="dragStart(event)" ondragend="dragEnd(event)">
                            <div style="font-weight: 500; margin-bottom: 5px;">${task.name}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">${project ? project.name : 'No Project'}</div>
                            <div style="margin-top: 5px;"><span class="user-tag">${task.assignee || 'Unassigned'}</span></div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span style="font-size: 10px;">📅 ${dateRange}</span>
                                <span style="font-size: 10px;">${task.priority}</span>
                            </div>
                        </div>`;
                });
                html += '</div></div>';
            });
            html += '</div>';
            container.innerHTML = html;
            
            document.querySelectorAll('.kanban-tasks').forEach(column => {
                column.addEventListener('dragover', dragOver);
                column.addEventListener('drop', dragDrop);
            });
        }

        function renderList(container) {
            const sortedTasks = [...data.tasks].sort((a, b) => {
                const dateA = new Date(a.dueDate);
                const dateB = new Date(b.dueDate);
                return dateA - dateB;
            });
            
            let html = '<div class="list-view">';
            html += '<div class="list-header"><div>Task</div><div>Duration</div><div>Status</div></div>';
            sortedTasks.forEach(task => {
                const dateRange = formatDateRange(task.startDate || task.dueDate, task.dueDate);
                html += `
                    <div class="list-row" onclick="editTask(${task.id})">
                        <div><div style="font-weight: 500; font-size: 12px;">${task.name}</div>
                            <div style="font-size: 10px; color: var(--text-secondary);">${task.assignee || 'Unassigned'}</div></div>
                        <div style="font-size: 11px;">${dateRange}</div>
                        <div><span class="status-badge status-${(task.status || 'not-started').toLowerCase().replace(' ', '-')}">${task.status || 'Not Started'}</span></div>
                    </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function updateStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            document.getElementById('totalProjects').textContent = data.projects.length;
            document.getElementById('totalTasks').textContent = data.tasks.length;
            document.getElementById('todayTasks').textContent = data.tasks.filter(t => {
                const due = new Date(t.dueDate);
                due.setHours(0, 0, 0, 0);
                return due.getTime() === today.getTime();
            }).length;
        }

        function toggleFabMenu() {
            document.getElementById('fabMenu').classList.toggle('show');
        }

        function showTaskModal() {
            editingTaskId = null;
            document.getElementById('taskModalTitle').textContent = 'New Task';
            document.getElementById('taskModal').classList.add('show');
            document.getElementById('taskName').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskPriority').value = 'Medium';
            document.getElementById('taskStart').value = new Date().toISOString().split('T')[0];
            document.getElementById('taskDue').value = '';
            populateDropdowns();
            toggleFabMenu();
        }

        function editTask(taskId) {
            editingTaskId = taskId;
            const task = data.tasks.find(t => t.id === taskId);
            document.getElementById('taskModalTitle').textContent = 'Edit Task';
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskProject').value = task.projectId;
            document.getElementById('taskAssignee').value = task.assignee || '';
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskStart').value = task.startDate || '';
            document.getElementById('taskDue').value = task.dueDate;
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskModal').classList.add('show');
            populateDropdowns();
        }

        function saveTask() {
            const taskData = {
                name: document.getElementById('taskName').value,
                projectId: parseInt(document.getElementById('taskProject').value),
                assignee: document.getElementById('taskAssignee').value,
                priority: document.getElementById('taskPriority').value,
                status: 'Not Started',
                progress: 0,
                startDate: document.getElementById('taskStart').value,
                dueDate: document.getElementById('taskDue').value,
                description: document.getElementById('taskDescription').value
            };
            
            if (!taskData.name || !taskData.projectId || !taskData.dueDate) {
                showToast('⚠️ Please fill required fields');
                return;
            }
            
            if (editingTaskId) {
                const index = data.tasks.findIndex(t => t.id === editingTaskId);
                data.tasks[index] = { ...data.tasks[index], ...taskData };
                addActivityLog(data.currentUser, `Updated task: ${taskData.name}`, 'task');
                showToast('✅ Task updated');
            } else {
                taskData.id = Date.now();
                taskData.createdBy = data.currentUser;
                taskData.createdAt = new Date().toISOString();
                data.tasks.push(taskData);
                addActivityLog(data.currentUser, `Created task: ${taskData.name}`, 'task');
                showToast('✅ Task created');
            }
            
            saveData();
            renderView();
            updateStats();
            closeModal('taskModal');
            
            if (data.autoSyncEnabled) {
                cloudSync.push(true);
            }
        }

        function deleteTask(taskId) {
            const task = data.tasks.find(t => t.id === taskId);
            if (confirm('Delete this task?')) {
                data.tasks = data.tasks.filter(t => t.id !== taskId);
                addActivityLog(data.currentUser, `Deleted task: ${task.name}`, 'task');
                saveData();
                renderView();
                updateStats();
                showToast('🗑️ Task deleted');
                
                if (data.autoSyncEnabled) {
                    cloudSync.push(true);
                }
            }
        }

        function showProjectModal() {
            editingProjectId = null;
            document.getElementById('projectModalTitle').textContent = 'New Project';
            document.getElementById('projectModal').classList.add('show');
            document.getElementById('projectName').value = '';
            document.getElementById('projectDescription').value = '';
            document.getElementById('projectStart').value = new Date().toISOString().split('T')[0];
            document.getElementById('projectEnd').value = '';
            populateDropdowns();
            toggleFabMenu();
        }

        function editProject(projectId) {
            editingProjectId = projectId;
            const project = data.projects.find(p => p.id === projectId);
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectDescription').value = project.description || '';
            document.getElementById('projectStart').value = project.startDate || '';
            document.getElementById('projectEnd').value = project.endDate || '';
            document.getElementById('projectLead').value = project.lead || '';
            document.getElementById('projectModal').classList.add('show');
            populateDropdowns();
        }

        function saveProject() {
            const projectData = {
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDescription').value,
                startDate: document.getElementById('projectStart').value,
                endDate: document.getElementById('projectEnd').value,
                lead: document.getElementById('projectLead').value
            };
            
            if (!projectData.name) {
                showToast('⚠️ Enter project name');
                return;
            }
            
            if (editingProjectId) {
                const index = data.projects.findIndex(p => p.id === editingProjectId);
                data.projects[index] = { ...data.projects[index], ...projectData };
                addActivityLog(data.currentUser, `Updated project: ${projectData.name}`, 'project');
                showToast('✅ Project updated');
            } else {
                projectData.id = Date.now();
                projectData.createdBy = data.currentUser;
                projectData.createdAt = new Date().toISOString();
                data.projects.push(projectData);
                addActivityLog(data.currentUser, `Created project: ${projectData.name}`, 'project');
                showToast('✅ Project created');
            }
            
            saveData();
            renderView();
            updateStats();
            closeModal('projectModal');
            
            if (data.autoSyncEnabled) {
                cloudSync.push(true);
            }
        }

        function deleteProject(projectId) {
            const project = data.projects.find(p => p.id === projectId);
            if (confirm('Delete project and all its tasks?')) {
                data.projects = data.projects.filter(p => p.id !== projectId);
                data.tasks = data.tasks.filter(t => t.projectId !== projectId);
                addActivityLog(data.currentUser, `Deleted project: ${project.name}`, 'project');
                saveData();
                renderView();
                updateStats();
                showToast('🗑️ Project deleted');
                
                if (data.autoSyncEnabled) {
                    cloudSync.push(true);
                }
            }
        }

        function showUserModal() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            data.users.forEach(user => {
                const isCurrent = user === data.currentUser;
                userList.innerHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-color); border-radius: 6px; margin-bottom: 5px;">
                        <span style="font-size: 13px;">${user} ${isCurrent ? '(You)' : ''}</span>
                        ${!isCurrent ? `<button class="btn btn-secondary" onclick="removeUser('${user}')" style="padding: 3px 8px; font-size: 11px;">Remove</button>` : ''}
                    </div>`;
            });
            document.getElementById('userModal').classList.add('show');
            toggleFabMenu();
        }

        function addUser() {
            const newUserName = document.getElementById('newUserName').value.trim();
            if (newUserName && !data.users.includes(newUserName)) {
                data.users.push(newUserName);
                addActivityLog(data.currentUser, `Added team member: ${newUserName}`, 'system');
                saveData();
                document.getElementById('newUserName').value = '';
                showUserModal();
                showToast(`✅ ${newUserName} added`);
            } else if (data.users.includes(newUserName)) {
                showToast('⚠️ User already exists');
            }
        }

        function removeUser(userName) {
            if (data.users.length > 1 && confirm(`Remove ${userName}?`)) {
                data.users = data.users.filter(u => u !== userName);
                data.tasks.forEach(task => {
                    if (task.assignee === userName) task.assignee = '';
                });
                data.projects.forEach(project => {
                    if (project.lead === userName) project.lead = '';
                });
                addActivityLog(data.currentUser, `Removed team member: ${userName}`, 'system');
                saveData();
                showUserModal();
                showToast(`🗑️ ${userName} removed`);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function dragStart(e) {
            draggedElement = e.target;
            e.target.classList.add('dragging');
        }

        function dragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function dragOver(e) {
            e.preventDefault();
        }

        function dragDrop(e) {
            e.preventDefault();
            if (draggedElement && e.currentTarget.classList.contains('kanban-tasks')) {
                const newStatus = e.currentTarget.dataset.status;
                const taskId = parseInt(draggedElement.dataset.taskId);
                const task = data.tasks.find(t => t.id === taskId);
                if (task) {
                    const oldStatus = task.status;
                    task.status = newStatus;
                    if (newStatus === 'Completed') task.progress = 100;
                    else if (newStatus === 'Not Started') task.progress = 0;
                    
                    addActivityLog(data.currentUser, `Moved "${task.name}" from ${oldStatus} to ${newStatus}`, 'task');
                    saveData();
                    renderKanban(document.getElementById('mainContent'));
                    updateStats();
                    showToast(`✅ Task moved to ${newStatus}`);
                    
                    if (data.autoSyncEnabled) {
                        cloudSync.push(true);
                    }
                }
            }
        }
    </script>
</body>
</html>
